<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player</title>
    <link rel="stylesheet" type="text/css" href="/assets/player/clappr/clap.css">
    <script src="//cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js" type="text/javascript"></script>
    <script src="//cdn.jsdelivr.net/gh/clappr/clappr-level-selector-plugin@latest/dist/level-selector.min.js" type="text/javascript"></script>
    <script src="//cdn.jsdelivr.net/npm/@clappr/hlsjs-playback@1.0.1/dist/hlsjs-playback.min.js"></script>
</head>
<body>
    <div id="player" style="height: 100%; width: 100%;"></div>

    <script>
        const apiBase = "https://api.jadoodigital.com/api/v2.1";
        const refreshToken = "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE3MzU4OTMyNTcsIm5iZiI6MTczNTg5MzI1NywianRpIjoiMzVlMjIyNzQtYWI4NC00OTE4LTg3NTUtMWYzOTM2YzZmZGZkIiwiZXhwIjoxNzM2NDk4MDU3LCJpZGVudGl0eSI6eyJpZCI6IjVkYTY3YTdhODM4NzQ2YzE4OWNjYzgyYmUyMjUxYzkyIiwiZG9tYWluIjoiYWYxZGQ4NmMzZmI4NDQ4ZTg3YmI3NzcwMDAwYzkzMGMiLCJwYWNrYWdlIjoiNDI2MTIwZjhkZjY3NDRiZjg0MDU5ODRmZjY5YzU0NzEifSwidHlwZSI6InJlZnJlc2gifQ.uwoa93P6aXvMswvRJ9PJIP3-gIFM2ojH2b8_Lk2Pnl8";

        async function fetchAccessToken() {
            try {
                const response = await fetch(`${apiBase}/user/auth/refresh`, {
                    method: "GET",
                    headers: {
                        "Authorization": refreshToken
                    }
                });
                const data = await response.json();
                return data.data.access_token;
            } catch (error) {
                console.error("Error fetching access token:", error);
                return null;
            }
        }

        async function fetchChannelLink(channelId, accessToken) {
            try {
                const response = await fetch(`${apiBase}/user/channel/${channelId}`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`
                    }
                });
                const data = await response.json();
                return data.url;
            } catch (error) {
                console.error("Error fetching channel link:", error);
                return null;
            }
        }

        async function initializePlayer() {
            const urlParams = new URLSearchParams(window.location.search);
            const channelId = urlParams.get("c");

            if (!channelId) {
                console.error("Channel ID is missing in the URL.");
                return;
            }

            const accessToken = await fetchAccessToken();
            if (!accessToken) return;

            const channelLink = await fetchChannelLink(channelId, accessToken);
            if (!channelLink) return;

            const player = new Clappr.Player({
                source: channelLink,
                width: '100%',
                height: '100%',
                autoPlay: true,
                plugins: [HlsjsPlayback, LevelSelector],
                mimeType: "application/x-mpegURL",
                mediacontrol: { seekbar: "#ff0000", buttons: "#eee" },
                parentId: "#player",
                levelSelectorConfig: true
            });

            player.on(Clappr.Events.PLAYER_ERROR, function () {
                console.log("Player encountered an error. Retrying...");
                setTimeout(() => {
                    player.load(player.options.source);
                    player.play();
                }, 100);
            });

            player.on(Clappr.Events.PLAYER_STOP, function () {
                console.log("Player stopped. Restarting playback...");
                player.play();
            });
        }

        // Initialize the player when the page loads
        document.addEventListener("DOMContentLoaded", initializePlayer);
    </script>
</body>
</html>
